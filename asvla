#!/usr/bin/env bash

humanize() {
  echo "$1" | sed -E 's|^[0-9]+-||' | tr '-' ' ' | awk '{print toupper(substr($0,1,1)) substr($0,2)}'
}

fetch_issue_type() {
  local issue_number=$1
  [[ -z $issue_number ]] && { echo "Issue number required" >&2; return 1; }

  local issue_type=$(gh api graphql -f query="query(\$owner: String!, \$repo: String!, \$number: Int!) { repository(owner: \$owner, name: \$repo) { issue(number: \$number) { issueType { name } } } }" -f owner=Asvla -f repo=bugs-and-requests -F number="$issue_number" --jq '.data.repository.issue.issueType.name')

  case $issue_type in
    Enhancement)
      echo "feature"
      ;;
    Bug)
      echo "fix"
      ;;
    Task)
      echo "chore"
      ;;
    Initiative)
      echo "Error: Initiative issues cannot be converted to branch type" >&2
      return 1
      ;;
    *)
      echo "Error: Unknown issue type '$issue_type'" >&2
      return 1
      ;;
  esac
}

fetch_project_item_id() {
  local issue_number=$1
  gh api graphql -f query='
    query($owner: String!, $repo: String!, $number: Int!) {
      repository(owner: $owner, name: $repo) {
        issue(number: $number) {
          projectItems(first: 1) {
            nodes { id }
          }
        }
      }
    }' -f owner=Asvla -f repo=bugs-and-requests -F number="$issue_number" \
    --jq '.data.repository.issue.projectItems.nodes[0].id'
}

set_asvla_issue_status() {
  project_id="PVT_kwDOBWpGXc4ASp5k"         # Asvla/bugs-and-requests
  field_id="PVTSSF_lADOBWpGXc4ASp5kzgL6fWw" # Status
  issue_number=$1
  status=$2

  item_id=$(fetch_project_item_id "$issue_number")
  [[ -z $item_id ]] && { echo "Could not find project item for issue #$issue_number" >&2; return 1; }

  case $status in
    "In Progress")
      single_select_option_id="3274b58b"
      ;;
    "QM Ready")
      single_select_option_id="afb464af"
      ;;
    Live)
      single_select_option_id="3e734099"
      ;;
    *)
      echo "Unknown status $status" >&2
      return 1
      ;;
  esac

  gh project item-edit --project-id $project_id --id $item_id --field-id $field_id --single-select-option-id $single_select_option_id
}

function start_command() {
  branch_title=$2
  issue_id=$(echo $branch_title | sed -En 's|([0-9]+)-.*|\1|p')
  if [[ -n $issue_id ]]; then
    branch_name="$(fetch_issue_type $issue_id)/$branch_title"
    set_asvla_issue_status $issue_id "In Progress"
  else
    branch_name="$(gum choose feature fix chore)/$branch_title"
  fi
  git checkout -b $branch_name
}

function pr_command() {
  branch_name=$(git branch --show-current)
  branch_issue_id=$(echo "$branch_name" | sed -n 's|^.*/\([0-9]*\)-.*|\1|p')

  if [[ -n $branch_issue_id ]]; then
    pr_body="Related to Asvla/bugs-and-requests#$branch_issue_id"
  else
    pr_body=""
  fi

  suggested_title="$(humanize "$branch_name")"
  pr_title=$(gum input --value "$suggested_title" --placeholder "PR title")
  git push -u origin "$branch_name" --quiet
  gh pr create --title "$pr_title" --body "$pr_body" --base main --head "$branch_name"
}

function comment_command() {
  # Check if first arg is a number (issue id) or the comment text
  if [[ $2 =~ ^[0-9]+$ ]]; then
    issue_id=$2
    comment_text=$3
  else
    issue_id=$(git branch --show-current | sed -n 's|^.*/\([0-9]*\)-.*|\1|p')
    comment_text=$2
  fi

  [[ -z $issue_id ]] && { echo "Issue ID not provided and could not be extracted from branch name" >&2; exit 1; }
  [[ -z $comment_text ]] && { echo "Comment text required" >&2; exit 1; }

  gh issue comment "$issue_id" --repo Asvla/bugs-and-requests --body "$comment_text"
}

function qm_command() {
  if ! gh pr view --json url &>/dev/null; then
    pr_command
  fi

  branch_issue_id=$(git branch --show-current | sed -n 's|^.*/\([0-9]*\)-.*|\1|p')
  issue_id="${branch_issue_id:-$2}"
  [[ -z $issue_id ]] && { echo "Issue number missing" >&2; exit 1; }

  gh issue comment "$issue_id" --repo Asvla/bugs-and-requests --body "@davemakara Test on `cf-url`"
  set_asvla_issue_status $issue_id "QM Ready"
}

case $1 in
  dev)
    test-with-file .git/HEAD bin/tools/dev/bun-install-run-dev.sh 3000
    ;;
  story|storybook)
    test-with-file .git/HEAD bin/tools/dev/bun-install-run-storybok.sh 6006
    ;;
  build)
    bun run build
    ;;
  check|typecheck)
    bunx tsc --noEmit
    ;;
  device)
    bun run build:ios-native:dev && bun run ios-build-device
    ;;
  env)
    export ACCOUNT_ID=fa89f206779976d0ce7ac1d2bc7a7b9a
    export API_TOKEN=KhakxtNSS0pGs12R8SFN5xCgZ_Q5mmPoZSXcZrk5
    PROJECT_NAME=asvla-site-frontend ./bin/build/scripts/read-cloudflare-env-vars.sh > cloudflare.stg.env
    PROJECT_NAME=asvla-site-frontend-prod-sync ./bin/build/scripts/read-cloudflare-env-vars.sh > cloudflare.prod.env
    ;;
  capenv)
    export CLOUDFLARE_API_TOKEN=KhakxtNSS0pGs12R8SFN5xCgZ_Q5mmPoZSXcZrk5
    ./bin/build/scripts/sync-capawesome-env.sh stg
    ./bin/build/scripts/sync-capawesome-env.sh prod
    ;;
  fixer)
    echo "# Fixer? I barely know 'er!"
    claude "Fix issue $2 in a separate branch and create a PR. The issue is in Asvla/bugs-and-requests repo, but fix here."
    ;;
  start)
    start_command "$@"    
    ;;
  pr)
    pr_command "$@"
    ;;
  qm|greenlight)
    qm_command "$@"
    ;;
  comment)
    comment_command "$@"
    ;;
  *)
    echo "Supported commands: dev, story[book], build, [type]check, device, vars, start, greenlight, comment"
    ;;
esac
